<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b1220"/>
  <title>Acid–Base (Nephro)</title>
  <style>
    :root{--bg:#0b1220;--card:#111a2e;--muted:#9fb0d0;--text:#e8efff;--accent:#6aa6ff;--danger:#ff6a6a;}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#070b14,var(--bg));color:var(--text)}
    header{padding:18px 16px 10px;position:sticky;top:0;background:rgba(11,18,32,.92);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
    header h1{margin:0;font-size:18px}
    header p{margin:6px 0 0;color:var(--muted);font-size:13px}
    main{padding:14px 12px 60px;max-width:1200px;margin:0 auto;display:grid;gap:10px}
    .card{background:rgba(17,26,46,.92);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0c1426;color:var(--text);cursor:pointer;font-weight:900}
    .tab.active{border-color:rgba(106,166,255,.55);box-shadow:0 0 0 2px rgba(106,166,255,.15) inset}
    .label{font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,button{width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c1426;color:var(--text);padding:12px;font-size:16px;outline:none}
    input::placeholder{color:rgba(159,176,208,.65)}
    button{background:linear-gradient(180deg, rgba(106,166,255,.25), rgba(106,166,255,.12));border:1px solid rgba(106,166,255,.35);cursor:pointer;font-weight:900}
    button:active{transform:translateY(1px)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--muted);font-size:12px;margin-top:8px}
    .err{color:var(--danger);font-size:13px;margin-top:8px}
    .hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:14px 0}
    .kpi{display:grid;gap:8px}
    .kpi .row{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
    .kpi b{font-size:14px}
    .foot{color:var(--muted);font-size:12px;line-height:1.35;margin-top:10px}
    .warn{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);padding:10px;border-radius:12px;margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}
    .calcbox{border:1px solid rgba(255,255,255,.10);background:rgba(12,20,38,.55);padding:12px;border-radius:12px;margin-top:12px}
    .calcbox h3{margin:0 0 8px;font-size:13px;color:var(--text)}
    .calcbox pre{margin:0;white-space:pre-wrap;word-break:break-word;color:var(--muted);font-size:12px;line-height:1.35}
    .explain{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);padding:12px;border-radius:12px;margin-top:12px}
    .explain h3{margin:0 0 8px;font-size:13px}
    .explain p{margin:0;color:var(--muted);font-size:12px;line-height:1.4}
    .gauge{border:1px solid rgba(255,255,255,.10);background:rgba(12,20,38,.55);padding:12px;border-radius:12px;margin-top:12px}
    .gauge h3{margin:0 0 8px;font-size:13px}
    .bar{position:relative;height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden}
    .bar .fill{position:absolute;top:0;left:0;height:100%;width:0%;background:rgba(106,166,255,.55)}
    .bar .tick{position:absolute;top:-6px;width:2px;height:22px;background:rgba(255,255,255,.22)}
    .bar .marker{position:absolute;top:-4px;width:10px;height:18px;border-radius:6px;background:rgba(255,255,255,.75);transform:translateX(-50%)}
    .legend{display:flex;justify-content:space-between;margin-top:8px;color:var(--muted);font-size:11px;gap:8px}
    .mnemoWrap{display:none;margin-top:12px}
    .mnemoGrid{display:grid;gap:10px}
    .mnemoCard{border:1px solid rgba(106,166,255,.25);background:rgba(106,166,255,.06);padding:12px;border-radius:12px}
    .mnemoCard h3{margin:0 0 8px;font-size:13px}
    .mnemoCard ul{margin:0;padding-left:18px;color:var(--muted);font-size:12px;line-height:1.4}
    @media(min-width:980px){
      main{grid-template-columns:1.0fr 1.0fr}
      .mnemoGrid{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
<header>
  <h1>Acid–Base (Nephro)</h1>
  <p>Visible math + AGMA vs NAGMA causes + Osm Gap for possible toxic ingestion.</p>
</header>

<main>
  <section class="card">
    <div class="tabs">
      <button class="tab active" data-tab="gas">1) Inputs</button>
      <button class="tab" data-tab="analysis">2) Analysis</button>
    </div>

    <div id="panel_gas" style="margin-top:12px;">
      <!-- BLOOD GAS -->
      <div class="grid3">
        <div>
          <div class="label">Sample type</div>
          <select id="sampleType">
            <option value="ABG">ABG (arterial)</option>
            <option value="VBG">VBG (venous)</option>
          </select>
        </div>
        <div>
          <div class="label">pH *</div>
          <input id="ph" type="number" step="any" placeholder="e.g., 7.28">
        </div>
        <div>
          <div class="label">pCO₂ (mmHg) *</div>
          <input id="pco2" type="number" step="any" placeholder="e.g., 55">
        </div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <div class="label">HCO₃ (mEq/L) *</div>
          <input id="hco3" type="number" step="any" placeholder="e.g., 18">
        </div>
        <div>
          <div class="label">Na (mEq/L) (for AG & Osm)</div>
          <input id="na" type="number" step="any" placeholder="e.g., 140">
        </div>
        <div>
          <div class="label">Cl (mEq/L) (for AG)</div>
          <input id="cl" type="number" step="any" placeholder="e.g., 104">
        </div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <div class="label">Albumin (g/dL) (optional AG correction)</div>
          <input id="alb" type="number" step="any" placeholder="e.g., 2.5">
        </div>
        <div>
          <div class="label">AG normal (fixed)</div>
          <input value="12" disabled>
        </div>
        <div>
          <div class="label">HCO₃ normal (fixed)</div>
          <input value="24" disabled>
        </div>
      </div>

      <div class="hr"></div>

      <!-- OSMOLALITY / OSM GAP -->
      <div class="foot" style="margin-bottom:8px;">
        <b>Osmolality / Osm Gap (to screen for toxic alcohols)</b><br>
        Calculated Osm = 2×Na + Glucose/18 + BUN/2.8 + Ethanol/3.7 (all in mg/dL; ethanol optional)
      </div>

      <div class="grid3">
        <div>
          <div class="label">Measured serum osmolality (mOsm/kg) (optional)</div>
          <input id="osm_meas" type="number" step="any" placeholder="e.g., 330">
        </div>
        <div>
          <div class="label">Glucose (mg/dL) (optional)</div>
          <input id="glu" type="number" step="any" placeholder="e.g., 520">
        </div>
        <div>
          <div class="label">BUN (mg/dL) (optional)</div>
          <input id="bun" type="number" step="any" placeholder="e.g., 28">
        </div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <div class="label">Ethanol (mg/dL) (optional)</div>
          <input id="etoh" type="number" step="any" placeholder="e.g., 0">
        </div>
        <div>
          <div class="label">Osm gap flag threshold (fixed)</div>
          <input value=">10 (suggestive), >20 (strong)" disabled>
        </div>
        <div>
          <div class="label">Notes</div>
          <input value="Osm gap is screening only" disabled>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <button id="runBtn">Run</button>
        <button id="resetBtn" type="button">Reset</button>
      </div>

      <div class="warn">
        <b>VBG → ABG estimate:</b> pH + <b>0.05</b>, pCO₂ − <b>5</b>, HCO₃ unchanged.
      </div>

      <div id="errGas" class="err"></div>
    </div>

    <div id="panel_analysis" style="margin-top:12px;display:none;">
      <div class="foot">Uses values from Inputs. Tap <b>Run</b> first.</div>
      <div id="errAnalysis" class="err"></div>

      <div id="deltaGauge" class="gauge" style="display:none;">
        <h3>Delta–delta visual (ΔAG/ΔHCO₃)</h3>
        <div class="bar">
          <div class="fill" id="ddFill"></div>
          <div class="tick" style="left:20%"></div>  <!-- 0.8 on 0–4 scale -->
          <div class="tick" style="left:50%"></div>  <!-- 2.0 on 0–4 scale -->
          <div class="marker" id="ddMarker" style="left:0%"></div>
        </div>
        <div class="legend">
          <span>&lt;0.8: AGMA + NAGMA</span>
          <span>0.8–2.0: “pure” AGMA</span>
          <span>&gt;2.0: AGMA + Met Alk</span>
        </div>
        <div class="explain" style="margin-top:10px;">
          <h3>Delta–delta interpretation</h3>
          <p id="ddMeaning">—</p>
        </div>
      </div>

      <div id="osmBox" class="gauge" style="display:none;">
        <h3>Osmolality / Osm Gap</h3>
        <div class="explain" style="margin-top:0;">
          <p id="osmMeaning">—</p>
        </div>
      </div>

      <div class="calcbox">
        <h3>Visible calculations</h3>
        <pre id="calcSteps">—</pre>
      </div>

      <div id="mnemoWrap" class="mnemoWrap">
        <div class="mnemoGrid">
          <div class="mnemoCard">
            <h3>CUTE DIMPLES (High–anion gap metabolic acidosis)</h3>
            <ul>
              <li><b>C</b> — Cyanide / Carbon monoxide</li>
              <li><b>U</b> — Uremia</li>
              <li><b>T</b> — Toluene (often mixed AG + non-AG)</li>
              <li><b>E</b> — Ethylene glycol</li>
              <li><b>D</b> — Diabetic ketoacidosis</li>
              <li><b>I</b> — Isoniazid / Iron</li>
              <li><b>M</b> — Methanol</li>
              <li><b>P</b> — Propylene glycol</li>
              <li><b>L</b> — Lactic acidosis</li>
              <li><b>S</b> — Salicylates (often mixed resp alkalosis + AGMA)</li>
            </ul>
          </div>
          <div class="mnemoCard">
            <h3>HARDUP (Non–anion gap metabolic acidosis)</h3>
            <ul>
              <li><b>H</b> — Hyperalimentation / excess chloride (e.g., TPN)</li>
              <li><b>A</b> — Acetazolamide</li>
              <li><b>R</b> — Renal tubular acidosis (Type 1/2/4)</li>
              <li><b>D</b> — Diarrhea (GI bicarbonate loss)</li>
              <li><b>U</b> — Ureteral diversion (ileal conduit/neobladder)</li>
              <li><b>P</b> — Pancreatic fistula (bicarbonate-rich loss)</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <button id="recalcBtn">Recalculate</button>
        <button id="backBtn" type="button">Back to Inputs</button>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="kpi" id="kpi"></div>
    <span class="pill" id="units">Units: —</span>
    <div class="hr"></div>
    <div class="foot" id="notes">Enter values and tap Run.</div>
  </aside>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  function toNum(v){
    if(v===null||v===undefined||String(v).trim()==="") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function must(name,n){
    if(n===null) throw new Error(`${name} is required`);
    return n;
  }
  function fmt(n,d=2){ return Number.isFinite(n) ? n.toFixed(d) : String(n); }
  function clearKPI(){ $("kpi").innerHTML=""; }
  function addKPI(label,value,unit=""){
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`<b>${label}</b><div>${value}${unit?` <span class="pill">${unit}</span>`:""}</div>`;
    $("kpi").appendChild(row);
  }
  function setUnits(u){ $("units").textContent = `Units: ${u}`; }
  function setNotes(t){ $("notes").textContent = t || ""; }
  function setCalcSteps(lines){ $("calcSteps").textContent = lines && lines.length ? lines.join("\n") : "—"; }

  // Tabs
  const tabs=[...document.querySelectorAll(".tab")];
  function showTab(key){
    for(const t of tabs) t.classList.toggle("active", t.dataset.tab===key);
    $("panel_gas").style.display = key==="gas" ? "block":"none";
    $("panel_analysis").style.display = key==="analysis" ? "block":"none";
    $("errGas").textContent=""; $("errAnalysis").textContent="";
  }
  tabs.forEach(t=>t.addEventListener("click",()=>showTab(t.dataset.tab)));

  let state = null;

  // Helpers
  function vbgToAbg(ph, pco2, hco3){ return { ph: ph + 0.05, pco2: pco2 - 5, hco3: hco3 }; }
  function anionGap(na, cl, hco3){ return na - (cl + hco3); }
  function agCorrected(ag, alb){ return ag + 2.5*(4.0 - alb); }
  function calcOsm(na, glu, bun, etoh){
    // Na in mEq/L; others mg/dL; ethanol optional
    // Calculated Osm (mOsm/kg) = 2*Na + Glu/18 + BUN/2.8 + EtOH/3.7
    return 2*na + (glu/18) + (bun/2.8) + (etoh/3.7);
  }

  // Compensation rules
  function wintersExpectedPco2(hco3){ const exp = 1.5*hco3 + 8; return { exp, low: exp-2, high: exp+2 }; }
  function metAlkExpectedPco2(hco3){ const exp = 0.7*(hco3 - 24) + 40; return { exp, low: exp-5, high: exp+5 }; }
  function respAcidExpectedHco3(pco2){ const delta = pco2 - 40; return { acute: 24 + 1.0*(delta/10), chronic: 24 + 3.5*(delta/10) }; }
  function respAlkExpectedHco3(pco2){ const delta = pco2 - 40; return { acute: 24 + 2.0*(delta/10), chronic: 24 + 5.0*(delta/10) }; }

  function classifyPH(ph){
    if(ph < 7.35) return "Acidemia";
    if(ph > 7.45) return "Alkalemia";
    return "Near-normal pH (mixed possible)";
  }

  function primaryProcess(ph, pco2, hco3){
    if(ph < 7.35){
      const metabolic = (hco3 < 22), respiratory = (pco2 > 45);
      if(metabolic && !respiratory) return "Primary metabolic acidosis";
      if(respiratory && !metabolic) return "Primary respiratory acidosis";
      if(metabolic && respiratory) return "Mixed: metabolic + respiratory acidosis";
      return "Acidemia with borderline drivers";
    }
    if(ph > 7.45){
      const metabolic = (hco3 > 26), respiratory = (pco2 < 35);
      if(metabolic && !respiratory) return "Primary metabolic alkalosis";
      if(respiratory && !metabolic) return "Primary respiratory alkalosis";
      if(metabolic && respiratory) return "Mixed: metabolic + respiratory alkalosis";
      return "Alkalemia with borderline drivers";
    }
    const metabT = (hco3 < 22) ? "metabolic acidosis tendency" : (hco3 > 26) ? "metabolic alkalosis tendency" : "HCO₃ near normal";
    const respT  = (pco2 > 45) ? "respiratory acidosis tendency" : (pco2 < 35) ? "respiratory alkalosis tendency" : "pCO₂ near normal";
    return `Near-normal pH: ${metabT}; ${respT}`;
  }

  function inferAcuteChronic(measured, acute, chronic){
    const dA = Math.abs(measured - acute), dC = Math.abs(measured - chronic);
    if(dA < dC) return { closer: "acute-pattern", dist: dA };
    if(dC < dA) return { closer: "chronic-pattern", dist: dC };
    return { closer: "equidistant", dist: dA };
  }

  function deltaDeltaMeaning(dd){
    if(dd < 0.8) return "Δ–Δ < 0.8: AGMA + concurrent NAGMA (extra HCO₃ loss).";
    if(dd <= 2.0) return "Δ–Δ 0.8–2.0: isolated (“pure”) AGMA.";
    return "Δ–Δ > 2.0: AGMA + concurrent metabolic alkalosis.";
  }

  function showDeltaGauge(dd){
    const cap = 4.0;
    const v = Math.max(0, Math.min(cap, dd));
    const pct = (v/cap)*100;
    $("deltaGauge").style.display = "block";
    $("ddFill").style.width = pct + "%";
    $("ddMarker").style.left = pct + "%";
    $("ddMeaning").textContent = `${fmt(dd,2)} → ${deltaDeltaMeaning(dd)}`;
  }
  function hideDeltaGauge(){
    $("deltaGauge").style.display = "none";
    $("ddFill").style.width = "0%";
    $("ddMarker").style.left = "0%";
    $("ddMeaning").textContent = "—";
  }

  function showMnemonics(show){ $("mnemoWrap").style.display = show ? "block" : "none"; }

  function showOsmBox(text){
    $("osmBox").style.display = "block";
    $("osmMeaning").textContent = text;
  }
  function hideOsmBox(){
    $("osmBox").style.display = "none";
    $("osmMeaning").textContent = "—";
  }

  function runAnalysis(){
    if(!state) throw new Error("No data available. Go to Inputs and tap Run.");

    clearKPI();
    setUnits("mEq/L, mmHg, mOsm/kg");
    hideDeltaGauge();
    hideOsmBox();
    showMnemonics(false);

    const steps = [];
    const {
      sampleType, inPh, inPco2, inHco3, abgPh, abgPco2, abgHco3,
      na, cl, alb,
      osm_meas, glu, bun, etoh
    } = state;

    // Visible VBG->ABG
    if(sampleType === "VBG"){
      steps.push("VBG → ABG estimate:");
      steps.push(`  pH_ABG = ${fmt(inPh,2)} + 0.05 = ${fmt(abgPh,2)}`);
      steps.push(`  pCO2_ABG = ${fmt(inPco2,1)} - 5 = ${fmt(abgPco2,1)} mmHg`);
      steps.push(`  HCO3_ABG = ${fmt(abgHco3,1)} mEq/L (unchanged)`);
      steps.push("");
    } else {
      steps.push("ABG selected: using entered values directly.");
      steps.push("");
    }

    addKPI("Values used (ABG) pH / pCO₂ / HCO₃", `${fmt(abgPh,2)} / ${fmt(abgPco2,1)} / ${fmt(abgHco3,1)}`, "");
    addKPI("pH status", classifyPH(abgPh), "");
    addKPI("Primary assessment", primaryProcess(abgPh, abgPco2, abgHco3), "");

    let flags = [];
    let showCute = false;
    let showHardup = false;
    let agElev = false;

    // Acid-base (same logic as before, condensed)
    if(abgPh < 7.35 && abgHco3 < 22){
      // Metabolic acidosis: compute AG if possible
      if(na!==null && cl!==null){
        const ag = anionGap(na, cl, abgHco3);
        addKPI("Anion gap (AG)", fmt(ag,2), "mEq/L");
        steps.push(`AG = ${fmt(na,1)} - (${fmt(cl,1)} + ${fmt(abgHco3,1)}) = ${fmt(ag,2)} mEq/L`);

        let agUse = ag;
        if(alb!==null){
          const agc = agCorrected(ag, alb);
          agUse = agc;
          addKPI("Albumin-corrected AG", fmt(agc,2), "mEq/L");
          steps.push(`AGcorr = ${fmt(ag,2)} + 2.5*(4 - ${fmt(alb,2)}) = ${fmt(agc,2)} mEq/L`);
        }

        agElev = (agUse > 14);
        addKPI("AG status", agElev ? "Elevated AG" : "Normal AG", "");

        if(agElev) showCute = true;
        if(!agElev) showHardup = true;

        // Delta–delta (only if AG elevated)
        if(agElev){
          const dAG = agUse - 12;
          const dH = 24 - abgHco3;
          if(dH > 0){
            const dd = dAG / dH;
            addKPI("Delta–delta (ΔAG/ΔHCO₃)", fmt(dd,2), "");
            addKPI("Delta–delta meaning", deltaDeltaMeaning(dd), "");
            showDeltaGauge(dd);

            steps.push(`ΔAG = ${fmt(agUse,2)} - 12 = ${fmt(dAG,2)}`);
            steps.push(`ΔHCO3 = 24 - ${fmt(abgHco3,1)} = ${fmt(dH,2)}`);
            steps.push(`ΔΔ = ${fmt(dAG,2)} / ${fmt(dH,2)} = ${fmt(dd,2)}`);

            if(dd < 0.8){ showHardup = true; flags.push("Δ–Δ < 0.8: concurrent NAGMA likely."); }
            if(dd > 2.0){ flags.push("Δ–Δ > 2.0: concurrent metabolic alkalosis likely."); }
          }
        }
      } else {
        flags.push("Na/Cl missing → cannot compute AG or delta–delta.");
      }

      // Winter’s
      const w = wintersExpectedPco2(abgHco3);
      addKPI("Winter’s expected pCO₂", `${fmt(w.exp,1)} (range ${fmt(w.low,1)}–${fmt(w.high,1)})`, "mmHg");
      if(abgPco2 < w.low) flags.push("pCO₂ below Winter’s: concurrent respiratory alkalosis.");
      if(abgPco2 > w.high) flags.push("pCO₂ above Winter’s: concurrent respiratory acidosis.");
    }

    // Osm gap section (independent of pH; but most helpful if AGMA present)
    // Needs Na + (glu,bun default 0 if missing) and measured osm to compute gap.
    const canCalcOsm = (na !== null) && ( (glu!==null) || (bun!==null) || (etoh!==null) || true );
    if(osm_meas !== null && na !== null){
      const g = (glu ?? 0);
      const b = (bun ?? 0);
      const e = (etoh ?? 0);
      const osmCalc = calcOsm(na, g, b, e);
      const gap = osm_meas - osmCalc;

      addKPI("Calculated Osm", fmt(osmCalc,1), "mOsm/kg");
      addKPI("Measured Osm", fmt(osm_meas,1), "mOsm/kg");
      addKPI("Osm gap", fmt(gap,1), "mOsm/kg");

      steps.push("");
      steps.push("Calculated Osmolality:");
      steps.push(`  Osm(calc) = 2*Na + Glu/18 + BUN/2.8 + EtOH/3.7`);
      steps.push(`           = 2*${fmt(na,1)} + ${fmt(g,1)}/18 + ${fmt(b,1)}/2.8 + ${fmt(e,1)}/3.7`);
      steps.push(`           = ${fmt(osmCalc,1)} mOsm/kg`);
      steps.push(`  Osm gap = Osm(measured) - Osm(calc) = ${fmt(osm_meas,1)} - ${fmt(osmCalc,1)} = ${fmt(gap,1)} mOsm/kg`);

      let msg = `Osm gap ${fmt(gap,1)} mOsm/kg. `;
      if(gap > 20){
        msg += "Strongly elevated (>20): consider toxic alcohols (ethylene glycol, methanol, propylene glycol) especially if high AG metabolic acidosis.";
        flags.push("Osm gap >20: strong concern for toxic ingestion (context-dependent).");
      } else if(gap > 10){
        msg += "Elevated (>10): possible unmeasured osmoles; interpret with clinical context and acid–base pattern.";
        flags.push("Osm gap >10: possible unmeasured osmoles (toxins/other).");
      } else {
        msg += "Not significantly elevated (≤10): toxic alcohols less likely, but not excluded early or after metabolism/dialysis.";
      }

      if(agElev) msg += " Given elevated AG, toxin ingestion rises on the differential (see CUTE DIMPLES).";
      showOsmBox(msg);
    } else {
      // only show a note if user entered measured osm but lacks Na
      if(osm_meas !== null && na === null){
        flags.push("Measured osm provided but Na missing → cannot compute osm gap.");
      }
    }

    // Mnemonics display: show if either relevant
    if(showCute || showHardup) showMnemonics(true);

    setCalcSteps(steps);
    setNotes(flags.length ? flags.join(" ") : "No strong mixed-disorder flags using bedside rules.");
  }

  function run(){
    try{
      $("errGas").textContent="";
      $("errAnalysis").textContent="";
      const sampleType = $("sampleType").value;

      const ph = must("pH", toNum($("ph").value));
      const pco2 = must("pCO2", toNum($("pco2").value));
      const hco3 = must("HCO3", toNum($("hco3").value));

      const na = toNum($("na").value);
      const cl = toNum($("cl").value);
      const alb = toNum($("alb").value);

      const osm_meas = toNum($("osm_meas").value);
      const glu = toNum($("glu").value);
      const bun = toNum($("bun").value);
      const etoh = toNum($("etoh").value);

      if(ph < 6.8 || ph > 7.8) throw new Error("pH appears out of typical physiologic range.");
      if(pco2 < 5 || pco2 > 120) throw new Error("pCO₂ appears out of typical physiologic range.");
      if(hco3 < 1 || hco3 > 60) throw new Error("HCO₃ appears out of typical physiologic range.");

      const abg = (sampleType==="VBG") ? vbgToAbg(ph, pco2, hco3) : {ph, pco2, hco3};

      state = {
        sampleType,
        inPh: ph, inPco2: pco2, inHco3: hco3,
        abgPh: abg.ph, abgPco2: abg.pco2, abgHco3: abg.hco3,
        na, cl, alb,
        osm_meas, glu, bun, etoh
      };

      runAnalysis();
      showTab("analysis");
    }catch(e){
      $("errGas").textContent = e?.message || String(e);
    }
  }

  function resetAll(){
    ["ph","pco2","hco3","na","cl","alb","osm_meas","glu","bun","etoh"].forEach(id=>$(id).value="");
    $("sampleType").value="ABG";
    state=null;
    clearKPI();
    setUnits("—");
    setNotes("Reset.");
    setCalcSteps([]);
    $("deltaGauge").style.display="none";
    $("mnemoWrap").style.display="none";
    $("osmBox").style.display="none";
    $("errGas").textContent=""; $("errAnalysis").textContent="";
    showTab("gas");
  }

  $("runBtn").addEventListener("click", run);
  $("resetBtn").addEventListener("click", resetAll);
  $("recalcBtn").addEventListener("click", ()=>{ try{ $("errAnalysis").textContent=""; runAnalysis(); }catch(e){ $("errAnalysis").textContent=e?.message||String(e); }});
  $("backBtn").addEventListener("click", ()=>showTab("gas"));

  setUnits("—");
  setNotes("Enter values and tap Run.");
  setCalcSteps([]);
</script>
</body>
</html>

